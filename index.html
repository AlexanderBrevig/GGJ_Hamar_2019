<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" type="text/css" href="/static/style.css" />
  </head>
  <body>
    <div id="app" class="console">
      <div id="consoleOut" class="output">
        <div id="candy">
            
          <span>Initializing...</span><br />
          <span class="green">0.0002ms ok!</span><br />
          <span class="seperator">== == == == == == == == == == == == == == == == == == == == == ==</span></br>
          <pre id="ascii" contenteditable="false">
    _   __         ____  __                   __    _ __           
   / | / /___     / __ \/ /___ _________     / /   (_) /_____      
  /  |/ / __ \   / /_/ / / __ `/ ___/ _ \   / /   / / //_/ _ \     
 / /|  / /_/ /  / ____/ / /_/ / /__/  __/  / /___/ / ,< /  __/     
/_/ |_/\____/  /_/   /_/\__,_/\___/\___/  /_____/_/_/|_|\___/      
              ______  _____   ____     ____     ___           
             <  /__ \/__  /  / __ \   / __ \   <  /           
             / /__/ /  / /  / / / /  / / / /   / /            
            / // __/  / /  / /_/ /  / /_/ /   / /             
           /_//____/ /_(_)  \___(_)  \___(_) \_/              

          </pre></br>
          <span class="seperator">== == == == == == == == == == == == == == == == == == == == == ==</span></br>
          <span>Our home is <span class="red">under attack</span>!</span></br>
          <span>Please join in and help protect our beloved 127.0.0.1</span>
        </div>
        </br>
        <span class="gray">If <span class="green">your name</span> is mentioned, perform the requested <span class="blue">action</span><br>
      </div>
      <div id="actionConsole" class="action">
        <span>system@home$ </span>
        <textarea id="command" class="input" name="input" cols="30" rows="1"></textarea>
      </div>
      <div id="actionPanel">
        <div id="enterUsername">
          <input id="username" type="text" placeholder="username">
          <button id="submitUsername">Join</button>
        </div>
        <div id="idle">
          IDLE SCREEN
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      var room = undefined;
      var isHost = false;
      var username = undefined;
    
      let __d = msg => {
        console.log(msg);
      };

      let $ = (el) => document.getElementById(el);

      let ui = {
        show: (el) => { $(el).style.display = "block"; },
        hide: (el) => { $(el).style.display = "none"; },
        mk: (el) => document.createElement(el)
      };

      let evnt = {
        ifEnter: (evnt, thenDo) => {
          var o = evnt || event;
          if (o.keyCode == 13) {
            o.preventDefault();
            if (thenDo !== undefined) {
              thenDo();
            }
          }
        }
      };

      let configureGotRoomStartHost = (socket) => {
        socket.on("room", data => {
          isHost = true;
          // when we get a room, we can start the host
          startHost(data.id);

          $("ascii").innerHTML = data.ascii;
          cout("join " + colored(data.id, "green").outerHTML);
        });
      };
    
      let startHost = (id) => {
        __d("got room id: " + id);
        room = io('/' + id);
        configureRoomJoined(room);
        room.on("answerSummary", data => {
          // update UI on host
        });
      }

      let configureRoomJoined = (room) => {
        room.on("joined", name => {
          __d("user joined " + name); //TODO: actually print
          cout(colored(name, "green").outerHTML + " joined");
        });
      };

      let configureJoined = (socket) => {
        socket.on("joined", id => {
          __d("got joined " + id);

          room = io('/' + id);

          configureRoomJoined(room);

          room.on("joined", uname => {
            if (uname === username) {
              ui.show("idle");
            }
          })

          room.on("task", task => {
            __d(task);

            showTaskUI(task);
          });

          showJoinUI();
        });
      }

      let showJoinUI = () => {
        ui.hide("candy");
        ui.hide("actionConsole");
        ui.show("actionPanel");
        ui.show("enterUsername");

        $("enterUsername").onkeydown = o => {
          evnt.ifEnter(o, () => {
            $("submitUsername").click();
          });
        };
        $("submitUsername").onclick = () => {
          var val = $("username").value;
          ui.hide("enterUsername");
          username = val;
          room.emit("joined", username);
        };
      };

      let onCommandEnter = o => {
        evnt.ifEnter(o, ()=>{
          var val = $("command").value;
          if (val === "create") {
            socket.emit("createRoom");
          }
          else if (val.toLowerCase().startsWith("join ")) {
            val = val.replace("join ", "").replace("Join ", "").replace("JOIN ", "").trim(); //sanetize
            socket.emit("joinRoom", val);
          }
          else if (val.toLowerCase().startsWith("attack ")) {
            val = val.replace("attack ", "").trim();
            room.emit("task", val);
          }

          $("command").value = null;
        });
      }

      let showTaskUI = (task) => {
        if (task.players[0] == "everyone" 
            || task.players.includes(username)) {

          switch (task.action) {
            case "crack": showCrack(task); break;
            case "click": showClick(task); break;
            case "hold": showHold(task); break;
            case "count": showCount(task); break;
          }
        } else {
          ui.show("idle"); //make sure it is visible
        }
      }

      let colored = (msg, color) => {
        var spanmsg = ui.mk("span");
        spanmsg.classList = color;
        spanmsg.innerHTML = msg;
        return spanmsg;
      };

      let cout = (msg) => {
        var spanmsg = ui.mk("span");
        var spanmsgcontainer = ui.mk("span");
        var prefix = ui.mk("span");
        prefix.classList = "gray";
        prefix.innerHTML = "</br>system@home$ ";
        spanmsgcontainer.innerHTML = msg;
        spanmsg.append(prefix);
        spanmsg.append(spanmsgcontainer);

        $("consoleOut").append(spanmsg);
      };

    
      // The initial creation request for rooms are done through the console
      // This means that the next step is to listen for a recieved room
      // Finally we listen for joined cilents - then for joined clients to our room
      $("command").onkeydown = () => onCommandEnter();

      configureGotRoomStartHost(socket);
      configureJoined(socket);
    </script>
  </body>
</html>
